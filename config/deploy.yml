# Service name (used for container naming)
service: void-chronicles

# Docker image (GitHub Container Registry - free private images)
# Note: registry server (ghcr.io) is automatically prepended by Kamal
image: internetblacksmith/void-chronicles

# SSH configuration for connecting to VPS (uses deploy user, not root)
ssh:
  user: deploy
  port: 1447

# Server configuration
servers:
  web:
    hosts:
      - digitalocean-vps-deploy
    labels:
      # Traefik routing for HTTP/HTTPS (uses gcal-sinatra's Traefik instance)
      traefik.enable: true
      traefik.http.routers.void-web.rule: Host(`vc.internetblacksmith.dev`)
      traefik.http.routers.void-web.entrypoints: websecure
      traefik.http.routers.void-web.tls.certresolver: letsencrypt
      traefik.http.services.void-web.loadbalancer.server.port: 8080
      # Rate limiting (brute-force protection)
      traefik.http.routers.void-web.middlewares: void-ratelimit
      traefik.http.middlewares.void-ratelimit.ratelimit.average: 20
      traefik.http.middlewares.void-ratelimit.ratelimit.burst: 50
      traefik.http.middlewares.void-ratelimit.ratelimit.period: 1s
      # HTTP to HTTPS redirect
      traefik.http.routers.void-web-http.rule: Host(`vc.internetblacksmith.dev`)
      traefik.http.routers.void-web-http.entrypoints: web
      traefik.http.routers.void-web-http.middlewares: void-redirect-https
      traefik.http.middlewares.void-redirect-https.redirectscheme.scheme: https
      traefik.http.middlewares.void-redirect-https.redirectscheme.permanent: true
    options:
      # Connect to Traefik's private network for HTTP/HTTPS
      network: "private"
      # Only publish SSH port directly (app's SSH server on 2222, exposed as port 22)
      publish:
        - "22:2222"   # SSH
    proxy: false

# Readiness delay (no proxy, no healthcheck in config)
readiness_delay: 10

# Docker registry authentication (GitHub Container Registry)
registry:
  server: ghcr.io
  username: internetblacksmith
  password:
    - KAMAL_REGISTRY_PASSWORD

# Builder configuration
builder:
  arch: amd64
  args:
    BUILD_TIME: "<%= Time.now.utc.iso8601 %>"
    GIT_COMMIT: "<%= `git rev-parse --short HEAD 2>/dev/null || echo 'unknown'`.strip %>"

# Environment variables
# Note: Secrets are injected during deployment via Doppler on local machine,
# not fetched at runtime. These are passed to the container at runtime.
env:
  secret:
    - SSH_PASSWORD
    - SSH_REQUIRE_PASSWORD
    - SSH_HOST
    - SSH_PORT
    - HTTP_PORT
    - HTTPS_PORT
    - SENTRY_DSN
    - SENTRY_ENVIRONMENT
    - POSTHOG_API_KEY
    - POSTHOG_HOST

# DO NOT INCLUDE accessories section (no Redis needed)
# DO NOT INCLUDE traefik section (already running from gcal-sinatra)
# DO NOT INCLUDE proxy section (using Traefik instead of kamal-proxy)

# Persistent volumes for user progress, SSH keys, and SSL certificates
volumes:
  - void-data:/data
  - void-ssl:/data/ssl
