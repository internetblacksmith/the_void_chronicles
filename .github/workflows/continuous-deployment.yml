name: Continuous Deployment

on:
  push:
    branches: [main]
  workflow_run:
    workflows: ["Tests"]
    types:
      - completed

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'push' }}
    
    steps:
    - uses: actions/checkout@v5
    
    - name: Wait for tests to complete
      if: github.event_name == 'push'
      run: |
        echo "Waiting for tests to complete..."
        sleep 30
    
    - name: Check if tests passed
      id: test-check
      run: |
        # Get the status of the test workflow
        status=$(gh run list --workflow=test.yml --branch=main --limit=1 --json conclusion --jq '.[0].conclusion')
        if [ "$status" != "success" ] && [ "$status" != "" ]; then
          echo "Tests did not pass. Skipping deployment."
          echo "deploy=false" >> $GITHUB_OUTPUT
        else
          echo "Tests passed or no test results yet. Proceeding with deployment."
          echo "deploy=true" >> $GITHUB_OUTPUT
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Fly.io
      if: steps.test-check.outputs.deploy == 'true'
      uses: superfly/flyctl-actions/setup-flyctl@master
    
    - name: Deploy to Fly.io
      if: steps.test-check.outputs.deploy == 'true'
      run: flyctl deploy --remote-only
      env:
        FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
    
    - name: Verify deployment
      if: steps.test-check.outputs.deploy == 'true'
      run: |
        echo "Waiting for deployment to stabilize..."
        sleep 30
        
        # Check HTTP health
        curl -f https://the-void-chronicles.fly.dev/health || exit 1
        
        # Check app status
        flyctl status -a the-void-chronicles
      env:
        FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
    
    - name: Notify on failure
      if: failure()
      run: |
        echo "::error::Deployment failed! Check the logs for details."